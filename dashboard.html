<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="./images/logo.png" type="image/png">
  <title>Dashboard | LoopKart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#0EA5E9",
            dark: "#0B1C2D",
            blackdash: "#0F172A",
            greenPrimary: "#2D5016",
            greenLight: "#7FA35C",
            greenAccent: "#A8C686",
            greenMint: "#D4E7C5",
            greenDark: "#1A3409"
          }
        }
      }
    }
  </script>
  <style>
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .chat-message {
      animation: slideUp 0.3s ease-out;
    }
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-greenMint via-white to-greenMint min-h-screen flex flex-col">

<!-- TOP NAV -->
<header class="bg-gradient-to-r from-greenDark via-greenPrimary to-greenDark shadow-2xl px-6 py-4 flex items-center justify-between sticky top-0 z-10 border-b-4 border-greenLight">
  <div class="flex items-center gap-3">
    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg hover:scale-110 transition-transform">
      <a href="dashboard.html"><img src="./images/logo.png" width="35"></a>
    </div>
    <span class="font-bold text-2xl text-white drop-shadow-lg tracking-wide">LoopKart</span>
  </div>

  <div class="flex gap-4 items-center">
    <button id="profileBtn" class="bg-white/20 backdrop-blur-sm p-2.5 rounded-xl hover:bg-white/30 transition-all hover:scale-110 border border-white/30">
      <img src="./images/profile.png" width="28">
    </button>
    <button id="infoBtn" class="bg-white/20 backdrop-blur-sm p-2.5 rounded-xl hover:bg-white/30 transition-all hover:scale-110 border border-white/30">
      <img src="./images/information.png" width="28">
    </button>
  </div>
</header>

<!-- ACTION BAR -->
<section class="px-6 py-6">
  <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl p-6 flex gap-4 flex-wrap border border-greenLight/30">
    <button id="requestBtn" class="px-8 py-3.5 bg-gradient-to-r from-greenDark to-greenPrimary text-white rounded-xl font-bold shadow-lg hover:shadow-2xl hover:scale-105 transition-all border-2 border-greenPrimary">
      ğŸ“„ Request
    </button>
    <button id="uploadBtn" class="px-8 py-3.5 bg-white border-2 border-greenPrimary text-greenDark rounded-xl font-bold hover:bg-greenPrimary hover:text-white transition-all hover:scale-105 shadow-md hover:shadow-lg">
      â¬† Upload
    </button>
    <button id="addBtn" class="px-8 py-3.5 bg-white border-2 border-greenPrimary text-greenDark rounded-xl font-bold hover:bg-greenPrimary hover:text-white transition-all hover:scale-105 shadow-md hover:shadow-lg">
      â• Add
    </button>
    <button id="chatToggle" class="px-8 py-3.5 bg-gradient-to-r from-greenLight to-greenAccent text-white rounded-xl font-bold hover:shadow-2xl transition-all hover:scale-105 border-2 border-greenLight shadow-lg">
      ğŸ¤– Bot
    </button>
  </div>
</section>

<!-- MAIN -->
<main class="px-6 py-6 flex-1 space-y-6">

  <!-- SEARCH -->
  <div class="bg-gradient-to-br from-white to-greenMint/30 backdrop-blur-sm rounded-2xl shadow-2xl p-8 border-2 border-greenLight/40">
    <div class="flex items-center gap-4 mb-6">
      <div class="w-16 h-16 bg-gradient-to-br from-greenPrimary to-greenLight rounded-2xl flex items-center justify-center text-3xl shadow-xl">
        â™»ï¸
      </div>
      <h1 class="text-4xl font-bold bg-gradient-to-r from-greenDark to-greenLight bg-clip-text text-transparent">
        Welcome, <span id="username" class="text-greenPrimary"></span> ğŸ‘‹
      </h1>
    </div>

    <div class="relative max-w-md">
      <input id="searchInput"
        placeholder="Search materials..."
        class="w-full pl-12 pr-4 py-4 border-2 border-greenLight/50 rounded-xl focus:ring-2 focus:ring-greenPrimary focus:border-greenPrimary outline-none transition-all shadow-md bg-white" />
      <span class="absolute left-4 top-4 text-xl text-greenPrimary">ğŸ”</span>
    </div>
  </div>

  <!-- MATERIAL LIST -->
  <div id="materialList"
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
  </div>

</main>

<!-- FOOTER -->
<section class="bg-gradient-to-r from-greenDark via-greenPrimary to-greenDark text-white px-6 py-8 mt-8 border-t-4 border-greenLight">
  <p class="text-center text-sm font-semibold tracking-wide">â™»ï¸ Â© LoopKart - Sustainable Marketplace 2024 ğŸŒ</p>
</section>

<!-- MODAL BACKDROP -->
<div id="modalBackdrop" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-40"></div>

<!-- REQUEST MODAL -->
<div id="requestModal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-8 w-96 hidden z-50 border-2 border-greenPrimary">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-greenDark">ğŸ“„ Request Material</h2>
    <button class="close-modal text-2xl text-gray-500 hover:text-greenDark">âœ•</button>
  </div>
  <p class="text-gray-600 mb-4">Submit a request for materials you need.</p>
  <input type="text" placeholder="Material name..." class="w-full px-4 py-3 border-2 border-greenLight/40 rounded-xl mb-3 focus:outline-none focus:ring-2 focus:ring-greenPrimary">
  <textarea placeholder="Details..." class="w-full px-4 py-3 border-2 border-greenLight/40 rounded-xl mb-4 focus:outline-none focus:ring-2 focus:ring-greenPrimary" rows="3"></textarea>
  <button class="w-full bg-gradient-to-r from-greenDark to-greenPrimary text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">Submit Request</button>
</div>

<!-- UPLOAD MODAL -->
<div id="uploadModal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-8 w-96 hidden z-50 border-2 border-greenPrimary">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-greenDark">â¬† Upload Document</h2>
    <button class="close-modal text-2xl text-gray-500 hover:text-greenDark">âœ•</button>
  </div>
  <p class="text-gray-600 mb-4">Upload material documentation or images.</p>
  <div class="border-2 border-dashed border-greenLight/50 rounded-xl p-8 text-center mb-4 hover:border-greenPrimary transition-all cursor-pointer">
    <p class="text-3xl mb-2">ğŸ“</p>
    <p class="text-sm text-gray-600">Click or drag files here</p>
  </div>
  <button class="w-full bg-gradient-to-r from-greenDark to-greenPrimary text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">Upload</button>
</div>

<!-- ADD MODAL -->
<div id="addModal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-8 w-96 hidden z-50 border-2 border-greenPrimary">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-greenDark">â• Add Material</h2>
    <button class="close-modal text-2xl text-gray-500 hover:text-greenDark">âœ•</button>
  </div>
  <p class="text-gray-600 mb-4">Add new material to marketplace.</p>
  <input type="text" placeholder="Material name..." class="w-full px-4 py-3 border-2 border-greenLight/40 rounded-xl mb-3 focus:outline-none focus:ring-2 focus:ring-greenPrimary">
  <input type="text" placeholder="Price..." class="w-full px-4 py-3 border-2 border-greenLight/40 rounded-xl mb-3 focus:outline-none focus:ring-2 focus:ring-greenPrimary">
  <input type="text" placeholder="Quantity..." class="w-full px-4 py-3 border-2 border-greenLight/40 rounded-xl mb-4 focus:outline-none focus:ring-2 focus:ring-greenPrimary">
  <button class="w-full bg-gradient-to-r from-greenDark to-greenPrimary text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">Add Material</button>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-8 w-96 hidden z-50 border-2 border-greenPrimary">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-greenDark">ğŸ‘¤ Profile</h2>
    <button class="close-modal text-2xl text-gray-500 hover:text-greenDark">âœ•</button>
  </div>
  <div class="text-center mb-6">
    <div class="w-24 h-24 bg-gradient-to-br from-greenPrimary to-greenLight rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-white">ğŸ‘¤</div>
    <h3 class="text-xl font-bold text-greenDark" id="profileUsername"></h3>
    <p class="text-sm text-gray-600">LoopKart Member</p>
  </div>
  <div class="space-y-3">
    <div class="bg-greenMint/50 p-3 rounded-xl">
      <p class="text-xs text-gray-600">Email</p>
      <p class="font-semibold text-greenDark">user@loopkart.com</p>
    </div>
    <div class="bg-greenMint/50 p-3 rounded-xl">
      <p class="text-xs text-gray-600">Member Since</p>
      <p class="font-semibold text-greenDark">January 2024</p>
    </div>
  </div>
  <button class="w-full bg-gradient-to-r from-greenDark to-greenPrimary text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all mt-4">Edit Profile</button>
</div>

<!-- INFO MODAL -->
<div id="infoModal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-8 w-96 hidden z-50 border-2 border-greenPrimary">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-greenDark">â„¹ï¸ Information</h2>
    <button class="close-modal text-2xl text-gray-500 hover:text-greenDark">âœ•</button>
  </div>
  <div class="space-y-4">
    <div>
      <h3 class="font-bold text-greenDark mb-2">About LoopKart</h3>
      <p class="text-sm text-gray-600">LoopKart is a sustainable marketplace for buying and selling recycled materials. Join us in building a circular economy! â™»ï¸</p>
    </div>
    <div>
      <h3 class="font-bold text-greenDark mb-2">How It Works</h3>
      <p class="text-sm text-gray-600">Browse materials, chat with sellers, and make eco-friendly purchases. Every transaction helps the environment!</p>
    </div>
    <div>
      <h3 class="font-bold text-greenDark mb-2">Contact</h3>
      <p class="text-sm text-gray-600">ğŸ“§ support@loopkart.com<br>ğŸ“± +1 (555) 123-4567</p>
    </div>
  </div>
</div>

<!-- SEND REQUEST MODAL -->
<div id="sendRequestModal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-8 w-96 hidden z-50 border-2 border-greenPrimary">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-greenDark">ğŸ“© Send Request</h2>
    <button class="close-modal text-2xl text-gray-500 hover:text-greenDark">âœ•</button>
  </div>
  <div class="bg-greenMint/50 p-4 rounded-xl mb-4">
    <p class="text-sm text-gray-600 mb-1">Material</p>
    <p class="font-bold text-lg text-greenDark" id="requestMaterialName"></p>
    <p class="text-sm text-gray-600 mt-2">Seller</p>
    <p class="font-semibold text-greenDark" id="requestSellerName"></p>
  </div>
  <div class="space-y-3">
    <input type="text" id="requestQuantity" placeholder="Quantity needed..." class="w-full px-4 py-3 border-2 border-greenLight/40 rounded-xl focus:outline-none focus:ring-2 focus:ring-greenPrimary">
    <textarea id="requestMessage" placeholder="Message to seller..." class="w-full px-4 py-3 border-2 border-greenLight/40 rounded-xl focus:outline-none focus:ring-2 focus:ring-greenPrimary" rows="3"></textarea>
  </div>
  <button id="submitRequest" class="w-full bg-gradient-to-r from-greenDark to-greenPrimary text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all mt-4">
    Send Request
  </button>
</div>

<!-- CHATBOT WINDOW -->
<div id="chatWindow" 
  class="fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-2xl hidden flex-col z-50 overflow-hidden border-2 border-greenPrimary">
  
  <!-- Chat Header -->
  <div class="bg-gradient-to-br from-greenDark via-greenPrimary to-greenLight text-white p-5 flex items-center justify-between shadow-xl">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-2xl border-2 border-white/30">
        ğŸ¤–
      </div>
      <div>
        <h3 class="font-bold text-lg">Loopy AI</h3>
        <p class="text-xs opacity-90">Your Material Assistant</p>
      </div>
    </div>
    <button id="chatClose" class="text-2xl hover:scale-110 transition-transform bg-white/20 w-9 h-9 rounded-xl flex items-center justify-center border border-white/30">âœ•</button>
  </div>

  <!-- Chat Messages -->
  <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-greenMint/30 to-white">
    <div class="chat-message bg-gradient-to-r from-greenLight to-greenAccent text-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-md border border-greenLight">
      <p class="text-sm font-medium">Hello! I am Loopy ğŸ¤– What material would you like me to find for you?</p>
    </div>
  </div>

  <!-- Chat Input -->
  <div class="p-4 border-t-2 border-greenLight/30 bg-gradient-to-r from-white to-greenMint/20">
    <div class="flex gap-2">
      <input id="chatInput" 
        placeholder="Type your message..."
        class="flex-1 px-4 py-3 border-2 border-greenLight/40 rounded-full focus:outline-none focus:ring-2 focus:ring-greenPrimary focus:border-greenPrimary shadow-sm" />
      <button id="chatSend" 
        class="bg-gradient-to-r from-greenPrimary to-greenLight text-white px-6 py-3 rounded-full font-bold hover:shadow-lg hover:scale-105 transition-all">
        â¤
      </button>
    </div>
  </div>
</div>

<script type="module">
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

// âš ï¸ REPLACE WITH YOUR API KEY from https://aistudio.google.com/app/apikey
const API_KEY = "AIzaSyDY-pYXOxrmddjXw5rEn-6ni0VPoMIRndI";
const genAI = new GoogleGenerativeAI(API_KEY);

/* MODAL HANDLERS */
const modalBackdrop = document.getElementById("modalBackdrop");
const modals = {
  request: document.getElementById("requestModal"),
  upload: document.getElementById("uploadModal"),
  add: document.getElementById("addModal"),
  profile: document.getElementById("profileModal"),
  info: document.getElementById("infoModal"),
  sendRequest: document.getElementById("sendRequestModal")
};

function openModal(modalName) {
  modalBackdrop.classList.remove("hidden");
  modals[modalName].classList.remove("hidden");
}

function closeAllModals() {
  modalBackdrop.classList.add("hidden");
  Object.values(modals).forEach(modal => modal.classList.add("hidden"));
}

// Send Request function (called from material cards)
window.sendRequest = function(materialName, sellerName) {
  document.getElementById("requestMaterialName").innerText = materialName;
  document.getElementById("requestSellerName").innerText = sellerName;
  document.getElementById("requestQuantity").value = "";
  document.getElementById("requestMessage").value = "";
  openModal("sendRequest");
}

// Submit request handler
document.getElementById("submitRequest").addEventListener("click", () => {
  const quantity = document.getElementById("requestQuantity").value;
  const message = document.getElementById("requestMessage").value;
  const materialName = document.getElementById("requestMaterialName").innerText;
  
  if (quantity && message) {
    alert(`âœ… Request sent for ${materialName}!\n\nQuantity: ${quantity}\nMessage: ${message}`);
    closeAllModals();
  } else {
    alert("âš ï¸ Please fill in all fields!");
  }
});

// Button event listeners
document.getElementById("requestBtn").addEventListener("click", () => openModal("request"));
document.getElementById("uploadBtn").addEventListener("click", () => openModal("upload"));
document.getElementById("addBtn").addEventListener("click", () => openModal("add"));
document.getElementById("profileBtn").addEventListener("click", () => {
  document.getElementById("profileUsername").innerText = currentUser;
  openModal("profile");
});
document.getElementById("infoBtn").addEventListener("click", () => openModal("info"));

// Close modal handlers
modalBackdrop.addEventListener("click", closeAllModals);
document.querySelectorAll(".close-modal").forEach(btn => {
  btn.addEventListener("click", closeAllModals);
});

/* USER */
const currentUser = localStorage.getItem("username") || "Anonymous";
document.getElementById("username").innerText = currentUser;

/* MATERIALS */
let materials = JSON.parse(localStorage.getItem("materials")) || [];
const list = document.getElementById("materialList");
const searchInput = document.getElementById("searchInput");

function render(items) {
  list.innerHTML = "";

  if (items.length === 0) {
    list.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20">
      <div class="w-24 h-24 bg-gradient-to-br from-greenPrimary to-greenLight rounded-3xl flex items-center justify-center text-5xl mb-6 shadow-xl">
        ğŸ“¦
      </div>
      <p class="text-gray-600 text-xl font-semibold">No materials found</p>
      <p class="text-gray-400 text-sm mt-2">Add some materials to get started!</p>
    </div>`;
    return;
  }

  items.forEach(i => {
    list.innerHTML += `
      <div class="bg-white backdrop-blur-sm rounded-2xl shadow-xl p-6 space-y-3 border-2 border-greenLight/30 hover:border-greenPrimary hover:shadow-2xl transition-all hover:scale-105">
        <div class="flex items-start justify-between">
          <h3 class="font-bold text-xl text-greenDark">${i.name}</h3>
          <span class="text-3xl">â™»ï¸</span>
        </div>
        <p class="text-sm text-white font-bold bg-gradient-to-r from-greenPrimary to-greenLight inline-block px-4 py-2 rounded-full shadow-md">${i.material} â€¢ ${i.condition}</p>
        <p class="text-sm text-gray-600 leading-relaxed">${i.details || "No details"}</p>
        <div class="bg-gradient-to-r from-greenMint to-greenAccent/30 rounded-xl p-4 mt-3 border border-greenLight/20">
          <p class="font-bold text-3xl text-greenDark">â‚¹${i.price} <span class="text-base font-normal text-gray-600">${i.priceUnit}</span></p>
          <p class="text-sm text-gray-600 mt-2 font-medium">ğŸ“¦ Qty: ${i.quantity} ${i.quantityUnit}</p>
        </div>
        <p class="text-xs text-gray-500 mt-3">ğŸ‘¤ Seller: <span class="font-bold text-greenDark">${i.seller}</span></p>

        <div class="flex gap-2 mt-3">
          ${
            i.seller === currentUser
              ? `<button onclick="removeItem(${i.id})"
                   class="flex-1 text-white text-sm bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-semibold transition-all hover:scale-105 shadow-md">
                   âŒ Delete
                 </button>`
              : `<button onclick="sendRequest('${i.name}', '${i.seller}')"
                   class="flex-1 text-white text-sm bg-gradient-to-r from-greenDark to-greenPrimary hover:shadow-lg px-4 py-2 rounded-lg font-semibold transition-all hover:scale-105 shadow-md">
                   ğŸ“© Send Request
                 </button>`
          }
        </div>
      </div>`;
  });
}

window.removeItem = function(id) {
  materials = materials.filter(m => m.id !== id);
  localStorage.setItem("materials", JSON.stringify(materials));
  render(materials);
}

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  render(
    materials.filter(m =>
      m.name.toLowerCase().includes(q) ||
      m.material.toLowerCase().includes(q)
    )
  );
});

render(materials);

/* CHATBOT LOGIC */
const chatToggle = document.getElementById("chatToggle");
const chatWindow = document.getElementById("chatWindow");
const chatClose = document.getElementById("chatClose");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const chatSend = document.getElementById("chatSend");

chatToggle.addEventListener("click", () => {
  chatWindow.classList.toggle("hidden");
  chatWindow.classList.toggle("flex");
  if (!chatWindow.classList.contains("hidden")) {
    chatInput.focus();
  }
});

chatClose.addEventListener("click", () => {
  chatWindow.classList.add("hidden");
  chatWindow.classList.remove("flex");
});

function addMessage(text, isUser = false) {
  const msgDiv = document.createElement("div");
  if (isUser) {
    msgDiv.className = 'chat-message bg-gradient-to-r from-greenPrimary to-greenLight text-white ml-auto rounded-2xl rounded-tr-none p-4 max-w-[80%] shadow-md border border-greenPrimary';
  } else {
    msgDiv.className = 'chat-message bg-gradient-to-r from-greenLight to-greenAccent text-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-md border border-greenLight';
  }
  msgDiv.innerHTML = `<p class="text-sm whitespace-pre-line font-medium">${text}</p>`;
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Quick greetings response
function handleGreeting(msg) {
  const greetings = ['hi', 'hello', 'hey', 'namaste', 'hola', 'hii', 'hiii'];
  const msgLower = msg.toLowerCase().trim();
  
  if (greetings.includes(msgLower)) {
    const responses = [
      "Hi there! ğŸ‘‹ Looking for any specific material?",
      "Hello! ğŸ˜Š How can I help you find materials today?",
      "Hey! Ready to help you search for materials! What do you need?",
      "Hi! ğŸ¤– Tell me what material you're looking for!"
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  }
  return null;
}

// Search material in inventory
function searchMaterial(query) {
  const queryLower = query.toLowerCase();
  const found = materials.filter(m => {
    const name = (m.name || '').toLowerCase();
    const material = (m.material || '').toLowerCase();
    const seller = (m.seller || '').toLowerCase();
    const condition = (m.condition || '').toLowerCase();
    const details = (m.details || '').toLowerCase();
    
    return name.includes(queryLower) || 
           material.includes(queryLower) ||
           seller.includes(queryLower) ||
           condition.includes(queryLower) ||
           details.includes(queryLower);
  });
  
  console.log('Search query:', query);
  console.log('Found materials:', found);
  return found;
}

async function sendMessage() {
  const userMsg = chatInput.value.trim();
  if (!userMsg) return;

  addMessage(userMsg, true);
  chatInput.value = "";

  const greetingResponse = handleGreeting(userMsg);
  if (greetingResponse) {
    setTimeout(() => addMessage(greetingResponse), 500);
    return;
  }

  const foundMaterials = searchMaterial(userMsg);
  
  if (foundMaterials.length > 0) {
    setTimeout(() => {
      const item = foundMaterials[0];
      
      let message = `Great! I found "${item.name}" ğŸ‰\n\n`;
      message += `ğŸ’° Price: â‚¹${item.price} ${item.priceUnit}\n`;
      message += `ğŸ“¦ Quantity: ${item.quantity} ${item.quantityUnit}\n`;
      message += `âœ¨ Condition: ${item.condition}\n`;
      message += `ğŸ·ï¸ Material Type: ${item.material}\n`;
      if (item.details) {
        message += `ğŸ“ Details: ${item.details}\n`;
      }
      message += `ğŸ‘¤ Seller: ${item.seller}`;
      
      addMessage(message);
    }, 500);
    return;
  }

  const typingDiv = document.createElement("div");
  typingDiv.id = "typing";
  typingDiv.className = "chat-message bg-gradient-to-r from-greenLight to-greenAccent text-white rounded-2xl rounded-tl-none p-4 max-w-[80%] shadow-md border border-greenLight";
  typingDiv.innerHTML = `<p class="text-sm">Typing...</p>`;
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  const materialKeywords = ['find', 'search', 'need', 'want', 'looking', 'get', 'buy', 'material', 'steel', 'iron', 'plastic', 'wood', 'metal', 'cement', 'rod', 'wire', 'scrap', 'aluminium', 'copper', 'glass'];
  const seemsLikeMaterialSearch = materialKeywords.some(kw => userMsg.toLowerCase().includes(kw));

  if (seemsLikeMaterialSearch) {
    setTimeout(() => {
      document.getElementById("typing")?.remove();
      const notAvailableResponses = [
        "ğŸ˜” Sorry, that material is not available at the moment. Would you like me to notify you when it's in stock?",
        "âš ï¸ Unfortunately, we don't have that material right now. Can I help you find something similar?",
        "ğŸ” That material isn't available currently. Should I add it to your wishlist?",
        "ğŸ˜• Not in stock right now! But I can help you search for alternatives!"
      ];
      addMessage(notAvailableResponses[Math.floor(Math.random() * notAvailableResponses.length)]);
    }, 800);
    return;
  }

  try {
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    
    const inventoryData = materials.length > 0 
      ? materials.map(m => `${m.name} (${m.material}, â‚¹${m.price} ${m.priceUnit}, ${m.condition})`).join(", ")
      : "No items in inventory";

    const systemPrompt = `You are Loopy, LoopKart's friendly shopping assistant chatbot.
Current user: ${currentUser}
Available inventory: ${inventoryData}

RULES:
- Keep responses SHORT (1-2 sentences max)
- Be helpful and friendly
- Focus on helping users find materials
- If you don't know something, say "I'm still learning that! But I can help you search for materials."

Respond naturally to: ${userMsg}`;

    const result = await model.generateContent(systemPrompt);
    const response = result.response.text();

    document.getElementById("typing")?.remove();
    addMessage(response);

  } catch (err) {
    console.error("Gemini Error:", err);
    document.getElementById("typing")?.remove();
    
    const learningResponses = [
      "ğŸ¤” Sorry, I'm still learning! I'm best at finding materials for you. Try asking about specific items!",
      "ğŸ˜… I'm still learning that! But I'm great at searching materials - try me with 'iron rods' or 'plastic'!",
      "ğŸ“ Still learning! Right now I can help you find materials in our inventory. What are you looking for?",
      "ğŸ’¡ Hmm, I'm not sure about that yet! But I can definitely help you search for materials. What do you need?"
    ];
    addMessage(learningResponses[Math.floor(Math.random() * learningResponses.length)]);
  }
}

chatSend.addEventListener("click", sendMessage);
chatInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});
</script>

</body>
</html>
