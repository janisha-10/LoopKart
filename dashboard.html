<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="./images/logo.png" type="image/png">
  <title>Dashboard | LoopKart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#0EA5E9",
            dark: "#0B1C2D",
            blackdash: "#0F172A"
          }
        }
      }
    }
  </script>

  <style>
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .chat-message { animation: slideUp 0.3s ease-out; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- TOP NAV -->
<header class="bg-[#A8E6CF] shadow px-6 py-4 flex items-center justify-between sticky top-0 z-10">
  <div class="flex items-center gap-3">
    <a href="dashboard.html"><img src="./images/logo.png" width="30"></a>
  </div>
  <span class="font-semibold text-lg text-dark">LoopKart</span>

  <div class="flex gap-6 text-sm font-medium">
    <a href="profile.html" class="font-medium hover:text-primary"><img src="./images/profile.png" width="30"></a>
    <a href="info.html" class="font-medium hover:text-primary"><img src="./images/information.png" width="30"></a>
  </div>
</header>

<!-- ACTION BAR -->
<section class="px-6 py-4">
  <div class="bg-white rounded-xl shadow p-4 flex gap-4 flex-wrap">
    <a href="requests.html" class="px-5 py-2 bg-primary text-white rounded-lg">üìÑ Requests</a>
    <a href="add.html" class="px-5 py-2 bg-gray-200 rounded-lg">‚ûï Add</a>
    <button type="button" id="chatToggle" class="px-5 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">ü§ñ Bot</button>
  </div>
</section>

<!-- MAIN -->
<main class="px-6 py-6 flex-1 space-y-6">

  <!-- SEARCH -->
  <div class="bg-white rounded-xl shadow p-6 space-y-4">
    <h1 class="text-2xl font-semibold">
      Welcome, <span id="dashboardUsername" class="text-primary"></span>! üëã
    </h1>

    <div class="relative max-w-md">
      <input id="searchInput" type="text" placeholder="Search materials..." class="w-full pl-10 pr-4 py-2 border rounded-lg" />
      <span class="absolute left-3 top-2.5">üîç</span>
    </div>
  </div>

  <!-- MATERIAL LIST -->
  <div id="materialList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

</main>

<!-- FOOTER -->
<section class="bg-blackdash text-white px-6 py-6">
  <p class="text-center text-sm">¬© LoopKart</p>
</section>

<!-- REQUEST POPUP -->
<div id="requestPopup" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 text-center w-80">
    <h2 class="text-lg font-semibold mb-2">‚úÖ Request Sent</h2>
    <p class="text-gray-600 mb-4">Your purchase request has been sent to the seller successfully!</p>
    <button type="button" onclick="closeRequestPopup()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">OK</button>
  </div>
</div>

<!-- SELLER REQUEST MANAGEMENT POPUP -->
<div id="manageRequestPopup" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 text-center w-80 max-h-[70vh] overflow-y-auto">
    <h2 class="text-lg font-semibold mb-2">üì¨ Pending Requests</h2>
    <div id="pendingRequestsContainer" class="space-y-3 text-left"></div>
    <button id="closeManagePopupBtn" class="bg-gray-300 text-black px-6 py-2 rounded-lg hover:bg-gray-400 mt-4">Close</button>
  </div>
</div>

<!-- CHATBOT WINDOW -->
<div id="chatWindow" class="fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-2xl hidden flex-col z-50 overflow-hidden">
  <div class="bg-gradient-to-r from-blue-600 to-primary text-white p-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="text-2xl">ü™Ñ</span>
      <div>
        <h3 class="font-bold">Loopy - LoopKart AI</h3>
        <p class="text-xs opacity-90">Your Shopping Assistant</p>
      </div>
    </div>
    <button type="button" id="chatClose" class="text-2xl hover:scale-110 transition-transform">‚úï</button>
  </div>

  <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
    <div class="chat-message bg-blue-100 rounded-2xl rounded-tl-none p-3 max-w-[80%]">
      <p class="text-sm">Hello! I am Loopy ü§ñ I can help you find materials.</p>
    </div>
  </div>

  <div class="p-4 border-t bg-white">
    <div class="flex gap-2">
      <input type="text" id="chatInput" placeholder="Type your message..." class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-primary" />
      <button type="button" id="chatSend" class="bg-primary text-white px-5 py-2 rounded-full font-bold hover:bg-blue-600 transition-colors">‚û§</button>
    </div>
  </div>
</div>

<script type="module">
// =================== DASHBOARD USER ===================
const currentUser = localStorage.getItem("username") || "Anonymous";
document.getElementById("dashboardUsername").innerText = currentUser;

// =================== MATERIALS & REQUESTS ===================
let materials = JSON.parse(localStorage.getItem("materials")) || [];
let purchaseRequests = JSON.parse(localStorage.getItem("purchaseRequests")) || [];
const list = document.getElementById("materialList");
const searchInput = document.getElementById("searchInput");

// =================== RENDER MATERIALS ===================
function render(items){
  list.innerHTML = "";
  if(items.length===0){ list.innerHTML=`<p class="text-gray-500">No materials found.</p>`; return; }

  items.forEach(i=>{
    const isOwn = i.seller===currentUser;
    const card = document.createElement('div');
    card.className='bg-white rounded-xl shadow p-4 space-y-1';
    card.innerHTML=`
      <h3 class="font-semibold text-lg">${i.name}</h3>
      <p class="text-sm text-gray-600">${i.material} ‚Ä¢ ${i.condition}</p>
      <p class="text-sm">${i.details||"No details"}</p>
      <p class="font-medium mt-2">‚Çπ${i.price} ${i.priceUnit}</p>
      <p class="text-sm text-gray-500">Qty: ${i.quantity} ${i.quantityUnit}</p>
      <p class="text-xs text-gray-400">Seller: ${i.seller}</p>
      <div class="flex gap-2 mt-3"></div>
    `;
    const btnContainer = card.querySelector('div');

    if(isOwn){
      const manageBtn=document.createElement('button');
      manageBtn.type="button";
      manageBtn.className='bg-yellow-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-yellow-600';
      manageBtn.innerHTML='üì¨ Manage Requests';
      manageBtn.onclick=()=>showManageRequests(i.seller);
      btnContainer.appendChild(manageBtn);

      const deleteBtn=document.createElement('button');
      deleteBtn.type="button";
      deleteBtn.className='text-red-500 text-sm px-3 py-1 border border-red-500 rounded-lg hover:bg-red-50';
      deleteBtn.innerHTML='‚ùå Delete';
      deleteBtn.onclick=()=>removeItem(i.id);
      btnContainer.appendChild(deleteBtn);
    }else{
      const requestBtn=document.createElement('button');
      requestBtn.type="button";
      requestBtn.className='bg-green-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-green-600';
      requestBtn.innerHTML='üì§ Send Request';
      requestBtn.onclick=()=>sendRequest(i.id);
      btnContainer.appendChild(requestBtn);
    }

    list.appendChild(card);
  });
}

// =================== REMOVE ITEM ===================
window.removeItem=function(id){
  materials=materials.filter(m=>m.id!==id);
  localStorage.setItem("materials",JSON.stringify(materials));
  render(materials);
}

// =================== SEND REQUEST ===================
window.sendRequest=function(itemId){
  const item=materials.find(m=>m.id===itemId);
  if(!item){ alert("Item not found"); return; }
  const req={
    id:Date.now(),
    itemId,
    itemName:item.name,
    buyer:currentUser,
    seller:item.seller,
    price:item.price,
    priceUnit:item.priceUnit,
    quantity:item.quantity,
    quantityUnit:item.quantityUnit,
    timestamp:new Date().toISOString(),
    status:"pending"
  };
  purchaseRequests.push(req);
  localStorage.setItem("purchaseRequests",JSON.stringify(purchaseRequests));
  document.getElementById("requestPopup").classList.remove("hidden");
  document.getElementById("requestPopup").classList.add("flex");
}
window.closeRequestPopup=function(){
  const popup=document.getElementById("requestPopup");
  popup.classList.add("hidden");
  popup.classList.remove("flex");
}

// =================== MANAGE REQUESTS ===================
function showManageRequests(seller){
  const container=document.getElementById("pendingRequestsContainer");
  container.innerHTML="";

  const pending=purchaseRequests.filter(r=>r.seller===seller && r.status==="pending");
  if(pending.length===0) container.innerHTML="<p class='text-gray-500'>No pending requests.</p>";

  pending.forEach(r=>{
    const div=document.createElement("div");
    div.className="p-3 border rounded-lg space-y-1";
    div.innerHTML=`
      <p><strong>${r.itemName}</strong> requested by <span class="text-primary">${r.buyer}</span></p>
      <p>Qty: ${r.quantity} ${r.quantityUnit} ‚Ä¢ Price: ‚Çπ${r.price} ${r.priceUnit}</p>
      <div class="flex gap-2 mt-1">
        <button type="button" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Approve</button>
        <button type="button" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Reject</button>
      </div>
    `;
    const [approveBtn,rejectBtn]=div.querySelectorAll("button");
    approveBtn.onclick=()=>updateRequestStatus(r.id,"approved");
    rejectBtn.onclick=()=>updateRequestStatus(r.id,"rejected");
    container.appendChild(div);
  });

  document.getElementById("manageRequestPopup").classList.remove("hidden");
  document.getElementById("manageRequestPopup").classList.add("flex");
}
function updateRequestStatus(id,status){
  const req=purchaseRequests.find(r=>r.id===id);
  if(req) req.status=status;
  localStorage.setItem("purchaseRequests",JSON.stringify(purchaseRequests));
  showManageRequests(currentUser);
}
document.getElementById("closeManagePopupBtn").addEventListener("click",()=>{
  const popup=document.getElementById("manageRequestPopup");
  popup.classList.add("hidden");
  popup.classList.remove("flex");
});

// =================== SEARCH ===================
searchInput.addEventListener("input",()=>{
  const q=searchInput.value.toLowerCase();
  render(materials.filter(m=>m.name.toLowerCase().includes(q)||m.material.toLowerCase().includes(q)));
});

render(materials);

// =================== CHATBOT ===================
const chatToggle=document.getElementById("chatToggle");
const chatWindow=document.getElementById("chatWindow");
const chatClose=document.getElementById("chatClose");
const chatMessages=document.getElementById("chatMessages");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");

chatToggle.addEventListener("click",()=>{
  chatWindow.classList.toggle("hidden");
  chatWindow.classList.toggle("flex");
  if(!chatWindow.classList.contains("hidden")) chatInput.focus();
});
chatClose.addEventListener("click",()=>{
  chatWindow.classList.add("hidden");
  chatWindow.classList.remove("flex");
});

function addMessage(text,isUser=false){
  const msgDiv=document.createElement("div");
  msgDiv.className=`chat-message ${isUser?'bg-primary text-white ml-auto rounded-tl-2xl':'bg-blue-100 rounded-tl-none'} rounded-2xl p-3 max-w-[80%]`;
  msgDiv.innerHTML=`<p class="text-sm whitespace-pre-line">${text}</p>`;
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

// ========== SEND CHAT ==========
chatSend.addEventListener("click",()=>{ sendChat(chatInput.value); });
chatInput.addEventListener("keypress",e=>{ if(e.key==="Enter") sendChat(chatInput.value); });

async function sendChat(msg){
  if(!msg.trim()) return;
  addMessage(msg,true);
  chatInput.value="";

  const text = msg.toLowerCase().trim();
  const greetings = ["hi","hello","hey","good morning","good evening","good afternoon"];
  
  // Check greetings
  if(greetings.some(g => text.includes(g))){
    addMessage("Hello! üëã I can help you find materials in LoopKart.");
    return;
  }

  // Search local inventory first
  const found = materials.filter(m=>m.name.toLowerCase().includes(text)||m.material.toLowerCase().includes(text));
  if(found.length>0){
    const response = found.map(m=>`${m.name} (${m.material}) - Qty: ${m.quantity} ${m.quantityUnit}, Price: ‚Çπ${m.price} ${m.priceUnit}`).join("\n");
    addMessage(response);
    return;
  }

  // Otherwise use AI API
  try{
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    const API_KEY="YOUR_API_KEY_HERE"; // Replace with your real API key
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({model:"gemini-1.5-flash"});
    const inventoryData = materials.length>0 ? materials.map(m=>`${m.name} (${m.material}, ‚Çπ${m.price} ${m.priceUnit})`).join(", ") : "No items in inventory";
    const systemPrompt = `You are Loopy, LoopKart's assistant. Inventory: ${inventoryData}. Respond to: ${msg}`;
    const result = await model.generateContent(systemPrompt);
    const response = result.response.text();
    addMessage(response);
  }catch{
    addMessage("ü§î I'm still learning! I can help you search materials.");
  }
}
</script>

</body>
</html>
